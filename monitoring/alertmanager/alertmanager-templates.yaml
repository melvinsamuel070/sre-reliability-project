apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: monitoring
data:
  email.tmpl: |
    {{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}
    
    {{ define "__text_alert_list" }}{{ range . }}
    Labels:
    {{ range .Labels.SortedPairs }}  {{ .Name }} = {{ .Value }}
    {{ end }}
    Annotations:
    {{ range .Annotations.SortedPairs }}  {{ .Name }} = {{ .Value }}
    {{ end }}
    Source: {{ .GeneratorURL }}
    {{ end }}{{ end }}
    
    {{ define "email.with.solution" }}
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .critical { background-color: #ffebee; border-left: 4px solid #f44336; }
            .warning { background-color: #fff3e0; border-left: 4px solid #ff9800; }
            .container { padding: 20px; margin: 20px auto; max-width: 800px; }
            .header { background: #2c3e50; color: white; padding: 15px; border-radius: 5px 5px 0 0; }
            .content { padding: 20px; background: white; }
            .solution { background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 15px 0; }
            .alert-details { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 15px 0; }
            .status-firing { color: #d32f2f; font-weight: bold; }
            .status-resolved { color: #388e3c; font-weight: bold; }
        </style>
    </head>
    <body>
        <div class="container {{ if eq .GroupLabels.severity "critical" }}critical{{ else }}warning{{ end }}">
            <div class="header">
                <h2>{{ if eq .GroupLabels.severity "critical" }}üö® CRITICAL ALERT{{ else }}‚ö†Ô∏è WARNING ALERT{{ end }}</h2>
                <h3>{{ .GroupLabels.alertname }}</h3>
            </div>
            <div class="content">
                <div class="alert-details">
                    <p><strong>Status:</strong> <span class="status-{{ .Status }}">{{ .Status | toUpper }}</span></p>
                    <p><strong>Risk Category:</strong> {{ .GroupLabels.risk | default "unknown" }}</p>
                    <p><strong>Severity:</strong> {{ .GroupLabels.severity | default "unknown" }}</p>
                    <p><strong>Summary:</strong> {{ (index .Alerts 0).Annotations.summary }}</p>
                    <p><strong>Description:</strong> {{ (index .Alerts 0).Annotations.description }}</p>
                </div>
                
                <div class="solution">
                    <h3>üîß IMMEDIATE SOLUTION</h3>
                    <pre style="white-space: pre-wrap; font-family: monospace;">{{ (index .Alerts 0).Annotations.solution }}</pre>
                </div>
                
                <div class="alert-details">
                    <h3>üìã Affected Resources:</h3>
                    <ul>
                    {{ range .Alerts }}
                        <li><strong>{{ .Labels.instance }}</strong> 
                        {{ if .Labels.pod }}(Pod: {{ .Labels.pod }}){{ end }}
                        - Started: {{ .StartsAt.Format "2006-01-02 15:04:05" }}</li>
                    {{ end }}
                    </ul>
                </div>
                
                <div class="alert-details">
                    <h3>üîó Quick Links:</h3>
                    <ul>
                        <li><a href="http://localhost:3000">Grafana Dashboard</a></li>
                        <li><a href="http://localhost:9090/alerts">Prometheus Alerts</a></li>
                        <li><a href="http://localhost:9090/graph">Prometheus Graph</a></li>
                        <li><a href="http://localhost:8001/api/v1/namespaces/monitoring/pods">Kubernetes Pods</a></li>
                    </ul>
                </div>
                
                <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
                    <p>Alert generated by Prometheus at {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
                    <p>Fingerprint: {{ .Fingerprint }}</p>
                </div>
            </div>
        </div>
    </body>
    </html>
    {{ end }}
    
    {{ define "critical.email" }}
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            body { font-family: Arial, sans-serif; background-color: #ffebee; }
            .container { padding: 20px; margin: 20px auto; max-width: 800px; background: white; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .header { background: #d32f2f; color: white; padding: 20px; border-radius: 5px 5px 0 0; text-align: center; }
            .urgency { background: #ffcdd2; padding: 10px; border-radius: 5px; margin: 15px 0; text-align: center; font-weight: bold; }
            .solution { background: #f1f8e9; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #4caf50; }
            .command { background: #263238; color: #fff; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üö® IMMEDIATE ACTION REQUIRED üö®</h1>
                <h2>{{ .GroupLabels.alertname }}</h2>
            </div>
            
            <div class="urgency">
                ‚è∞ THIS IS A CRITICAL PRODUCTION INCIDENT ‚è∞
            </div>
            
            <div>
                <h3>üìä Incident Details:</h3>
                <p><strong>Severity:</strong> {{ .GroupLabels.severity }}</p>
                <p><strong>Risk:</strong> {{ .GroupLabels.risk }}</p>
                <p><strong>Summary:</strong> {{ (index .Alerts 0).Annotations.summary }}</p>
                <p><strong>Description:</strong> {{ (index .Alerts 0).Annotations.description }}</p>
                <p><strong>Time Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}</p>
            </div>
            
            <div class="solution">
                <h3>üîß STEP-BY-STEP RESOLUTION:</h3>
                <pre style="white-space: pre-wrap; font-family: monospace; background: #f1f8e9; padding: 15px; border-radius: 5px;">{{ (index .Alerts 0).Annotations.solution }}</pre>
                
                <h4>Quick Commands to Run:</h4>
                {{ if eq .GroupLabels.alertname "SREAppDown" }}
                <div class="command">kubectl get pods -n monitoring -l app=sre-app</div>
                <div class="command">kubectl logs -n monitoring -l app=sre-app --tail=50</div>
                {{ end }}
                {{ if eq .GroupLabels.alertname "SREAppCrashLoop" }}
                <div class="command">kubectl delete pod -n monitoring -l app=sre-app</div>
                {{ end }}
                {{ if eq .GroupLabels.alertname "ClusterMemoryPressure" }}
                <div class="command">kubectl top pods --all-namespaces --sort-by=memory</div>
                {{ end }}
            </div>
            
            <div>
                <h3>üìû Escalation Path:</h3>
                <ol>
                    <li>Immediate: On-call engineer (this email)</li>
                    <li>30 minutes: SRE Team Lead</li>
                    <li>60 minutes: Head of Engineering</li>
                </ol>
            </div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px dashed #ddd;">
                <p><strong>‚ö†Ô∏è NEXT STEPS AFTER RESOLUTION:</strong></p>
                <ol>
                    <li>Document the incident in the post-mortem log</li>
                    <li>Update runbooks if new solution was found</li>
                    <li>Schedule follow-up to prevent recurrence</li>
                </ol>
            </div>
        </div>
    </body>
    </html>
    {{ end }}
    
    {{ define "slack.with.solution" }}
    {{ if eq .Status "firing" }}
    :warning: *Alert: {{ .GroupLabels.alertname }}*
    *Severity:* {{ .GroupLabels.severity }}
    *Risk:* {{ .GroupLabels.risk }}
    *Summary:* {{ (index .Alerts 0).Annotations.summary }}
    
    *Immediate Solution:*
    ```
    {{ (index .Alerts 0).Annotations.solution }}
    ```
    
    *Affected:* {{ range .Alerts }}{{ .Labels.instance }} {{ end }}
    
    *Links:*
    ‚Ä¢ <http://localhost:9090/alerts|Prometheus>
    ‚Ä¢ <http://localhost:3000|Grafana>
    {{ else }}
    :white_check_mark: *Resolved: {{ .GroupLabels.alertname }}*
    *Duration:* {{ .Alerts.Firing | len }} alerts resolved
    {{ end }}
    {{ end }}
    
    {{ define "slack.infra" }}
    :construction_site: *Infrastructure Alert: {{ .GroupLabels.alertname }}*
    *Node:* {{ range .Alerts }}{{ .Labels.instance }} {{ end }}
    *Issue:* {{ (index .Alerts 0).Annotations.summary }}
    
    *Action Required:*
    ```
    {{ (index .Alerts 0).Annotations.solution }}
    ```
    {{ end }}
    
    {{ define "slack.devops" }}
    :gear: *DevOps Alert: {{ .GroupLabels.alertname }}*
    *Component:* {{ .GroupLabels.component }}
    *Issue:* {{ (index .Alerts 0).Annotations.summary }}
    
    *Fix:*
    ```
    {{ (index .Alerts 0).Annotations.solution }}
    ```
    {{ end }}